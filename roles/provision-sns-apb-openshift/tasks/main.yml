- name: Launch SNS topic
  cloudformation:
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    stack_name: "apb-sns-{{ stack_identifier }}"
    state: "present"
    region: "{{ region }}"
    disable_rollback: false
    template: "{{ role_path }}/files/SNSTopic.yml"
    template_parameters:
      SubscriptionEndPoint: "{{ SubscriptionEndPoint if _apb_plan_id != 'topic' else '' }}"
      SubscriptionProtocol: "{{ SubscriptionProtocol  if _apb_plan_id != 'topic' else '' }}"
      ExistingTopicArn: "{{ ExistingTopicArn if _apb_plan_id == 'subscription' else '' }}"
      CreateTopic: "{{ 'No' if _apb_plan_id == 'subscription' else 'Yes' }}"
    tags:
      Stack: "ansible-cloudformation"
      Application: "ansible-sns"
      Description: "{{ stack_identifier }} sns"
  register: sns

- name: Check for SNS CloudFormation create error logs
  debug:
    var: sns.log

- name: Create SNS IAM user
  iam:
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    iam_type: user
    name: "apb-sns-iam-{{ stack_identifier }}"
    state: present
    access_key_state: create
  when: _apb_plan_id != "subscription"
  register: iam_output

- name: Attach SNS access IAM policy
  iam_policy:
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    iam_type: user
    iam_name: "apb-sns-iam-{{ stack_identifier }}"
    policy_name: "SNSFullAccessPolicy"
    state: present
    policy_document: "{{ role_path }}/files/SNSFullAccessPolicy.json"
  when: _apb_plan_id != "subscription"

- name: Encode bind credentials
  asb_encode_binding:
    fields:
      SNS_TOPIC_ARN:  "{{ sns.stack_outputs.TopicARN }}"
      AWS_ACCESS_KEY: "{{ iam_output.user_meta.access_keys[0].access_key_id if _apb_plan_id != 'subscription' else ' ' }}"
      AWS_SECRET_KEY: "{{ iam_output.user_meta.access_keys[0].secret_access_key if _apb_plan_id != 'subscription' else ' ' }}"
      AWS_REGION_NAME: "{{ region | string }}"
  when: sns.log | length <1